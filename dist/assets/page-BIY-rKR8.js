import{r as c,j as e,C as g,a as b,d as _,e as V,g as j,af as C,B as T,E as J,H as X,I as Y,J as K,K as q,aR as oe,f as B,bL as Q,ak as G,aE as de,aF as me,aG as xe,aH as he,aI as ue,aN as ge,aX as je,aJ as pe,aK as fe,F as U,bY as I,m as ve,n as Ne}from"./index-D2dOrPZ8.js";import{T as F}from"./triangle-alert-Cjhkzg0C.js";import{B as ee}from"./building-BsNnMwoW.js";import{R as be}from"./refresh-cw-DxjD_bXp.js";import{T as _e}from"./trending-down-DG-mIJr0.js";const W=[{value:"performance",label:"Baixa Performance"},{value:"compliance",label:"Não Conformidade"},{value:"financial",label:"Problemas Financeiros"},{value:"strategic",label:"Mudança Estratégica"},{value:"voluntary",label:"Saída Voluntária"},{value:"contract",label:"Fim de Contrato"},{value:"other",label:"Outros Motivos"}];function ye({projects:y,agencies:D,onProcessChurn:x,onRedistributeProjects:H}){const[r,w]=c.useState(null),[h,S]=c.useState(""),[k,A]=c.useState(""),[l,p]=c.useState([]),[u,a]=c.useState([]),[d,o]=c.useState(!1),[f,m]=c.useState(!1),[P,O]=c.useState(!1),[E,se]=c.useState(!0),v=r?y.filter(s=>s.partner_agency.id===r.id&&s.status==="ativo"):[],N=D.filter(s=>s.id!==r?.id&&s.partner_level!=="basic"),ae=s=>{w(s),p([]),a([]),S(""),A("")},te=(s,t)=>{t?p(n=>[...n,s]):(p(n=>n.filter(i=>i!==s)),a(n=>n.filter(i=>i.project_id!==s)))},ne=(s,t)=>{if(!r)return;const n=u.findIndex(R=>R.project_id===s),i={project_id:s,from_agency_id:r.id,to_agency_id:t,redistribution_date:new Date().toISOString().split("T")[0],reason:`Churn da agência ${r.name}`,client_notified:E};n>=0?a(R=>R.map((le,ce)=>ce===n?i:le)):a(R=>[...R,i])},re=()=>{if(!r||l.length===0)return;const s=[];l.forEach((t,n)=>{const i=N[n%N.length];s.push({project_id:t,from_agency_id:r.id,to_agency_id:i.id,redistribution_date:new Date().toISOString().split("T")[0],reason:`Churn da agência ${r.name}`,client_notified:E})}),a(s)},ie=async()=>{if(!r||!h||l.length===0){alert("Por favor, preencha todos os campos obrigatórios");return}if(l.filter(t=>!u.find(n=>n.project_id===t)).length>0){alert("Todos os projetos afetados devem ter uma agência de destino definida");return}O(!0);try{const t={partner_agency_id:r.id,reason:h==="other"?k:h,affected_projects:l,redistribution_plan:u};await x(t),await H(u),w(null),p([]),a([]),S(""),A(""),o(!1),m(!1)}catch(t){console.error("Erro ao processar churn:",t),alert("Erro ao processar saída da agência")}finally{O(!1)}},M=s=>new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(s),Z=()=>l.reduce((s,t)=>{const n=v.find(i=>i.id===t);return s+(n?.value||0)},0),z=s=>v.find(t=>t.id===s),$=s=>N.find(t=>t.id===s);return e.jsxs(g,{children:[e.jsxs(b,{children:[e.jsxs(_,{className:"flex items-center gap-2",children:[e.jsx(F,{className:"h-5 w-5 text-orange-500"}),"Gestão de Churn - Agências Partner"]}),e.jsx(V,{children:"Gerencie a saída de agências Partner e redistribuição de projetos"})]}),e.jsxs(j,{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx(C,{className:"text-sm font-medium text-gray-700",children:"Selecionar Agência"}),e.jsx("div",{className:"mt-2 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3",children:D.map(s=>{const t=y.filter(n=>n.partner_agency.id===s.id&&n.status==="ativo").length;return e.jsx(g,{className:`cursor-pointer transition-all hover:shadow-md ${r?.id===s.id?"ring-2 ring-blue-500 bg-blue-50":""}`,onClick:()=>ae(s),children:e.jsx(j,{className:"p-4",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-medium",children:s.name}),e.jsx("p",{className:"text-sm text-gray-600",children:s.contact_person}),e.jsxs("div",{className:"flex items-center gap-2 mt-2",children:[e.jsx(T,{variant:"outline",className:"text-xs",children:s.partner_level}),e.jsxs("span",{className:"text-xs text-gray-500",children:[t," projetos ativos"]})]})]}),e.jsx("div",{className:"text-right",children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"text-sm font-medium",children:s.satisfaction_rating}),e.jsx("span",{className:"text-xs text-gray-500",children:"/5"})]})})]})})},s.id)})})]}),r&&e.jsxs(g,{className:"border-orange-200 bg-orange-50",children:[e.jsxs(b,{children:[e.jsxs(_,{className:"text-lg flex items-center gap-2",children:[e.jsx(ee,{className:"h-5 w-5"}),"Processar Saída: ",r.name]}),e.jsxs(V,{children:[v.length," projetos ativos serão afetados"]})]}),e.jsxs(j,{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx(C,{htmlFor:"churn-reason",children:"Motivo da Saída *"}),e.jsxs(J,{value:h,onValueChange:S,children:[e.jsx(X,{children:e.jsx(Y,{placeholder:"Selecione o motivo"})}),e.jsx(K,{children:W.map(s=>e.jsx(q,{value:s.value,children:s.label},s.value))})]}),h==="other"&&e.jsx(oe,{placeholder:"Descreva o motivo...",value:k,onChange:s=>A(s.target.value),className:"mt-2"})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs(C,{className:"text-sm font-medium text-gray-700",children:["Projetos Afetados (",l.length,"/",v.length,")"]}),e.jsx(B,{variant:"outline",size:"sm",onClick:()=>{l.length===v.length?(p([]),a([])):p(v.map(s=>s.id))},children:l.length===v.length?"Desmarcar Todos":"Selecionar Todos"})]}),e.jsx("div",{className:"space-y-2 max-h-60 overflow-y-auto",children:v.map(s=>e.jsxs("div",{className:"flex items-center space-x-3 p-3 bg-white rounded-lg border",children:[e.jsx(Q,{checked:l.includes(s.id),onCheckedChange:t=>te(s.id,t)}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-medium",children:s.title}),e.jsxs("div",{className:"flex items-center gap-4 text-sm text-gray-600",children:[e.jsx("span",{children:s.client.name}),e.jsx("span",{children:M(s.value)}),e.jsx(T,{variant:"outline",className:"text-xs",children:s.status})]})]})]},s.id))}),l.length>0&&e.jsx("div",{className:"mt-3 p-3 bg-blue-50 rounded-lg",children:e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("span",{className:"font-medium",children:"Valor Total Afetado:"}),e.jsx("span",{className:"font-bold text-blue-600",children:M(Z())})]})})]}),l.length>0&&e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx(C,{className:"text-sm font-medium text-gray-700",children:"Plano de Redistribuição"}),e.jsxs(B,{variant:"outline",size:"sm",onClick:re,disabled:N.length===0,children:[e.jsx(be,{className:"h-4 w-4 mr-2"}),"Distribuir Automaticamente"]})]}),N.length===0?e.jsxs("div",{className:"p-4 bg-red-50 border border-red-200 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2 text-red-800",children:[e.jsx(F,{className:"h-4 w-4"}),e.jsx("span",{className:"font-medium",children:"Nenhuma agência disponível"})]}),e.jsx("p",{className:"text-sm text-red-700 mt-1",children:"Não há agências Partner Premium/Elite disponíveis para receber os projetos."})]}):e.jsx("div",{className:"space-y-3",children:l.map(s=>{const t=z(s),n=u.find(i=>i.project_id===s);return n&&$(n.to_agency_id),e.jsxs("div",{className:"flex items-center gap-4 p-3 bg-white rounded-lg border",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-medium",children:t?.title}),e.jsx("p",{className:"text-sm text-gray-600",children:t?.client.name})]}),e.jsx(G,{className:"h-4 w-4 text-gray-400"}),e.jsx("div",{className:"w-64",children:e.jsxs(J,{value:n?.to_agency_id||"",onValueChange:i=>ne(s,i),children:[e.jsx(X,{children:e.jsx(Y,{placeholder:"Selecionar agência"})}),e.jsx(K,{children:N.map(i=>e.jsx(q,{value:i.id,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{children:i.name}),e.jsx(T,{variant:"outline",className:"text-xs",children:i.partner_level})]})},i.id))})]})})]},s)})})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Q,{id:"notify-clients",checked:E,onCheckedChange:s=>se(s)}),e.jsx(C,{htmlFor:"notify-clients",className:"text-sm",children:"Notificar clientes sobre a mudança de agência"})]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-4 border-t",children:[e.jsx(B,{variant:"outline",onClick:()=>w(null),children:"Cancelar"}),e.jsx(B,{onClick:()=>m(!0),disabled:!h||l.length===0||u.length!==l.length||N.length===0,className:"bg-orange-600 hover:bg-orange-700",children:"Processar Saída da Agência"})]})]})]}),e.jsx(de,{open:f,onOpenChange:m,children:e.jsxs(me,{className:"max-w-2xl",children:[e.jsxs(xe,{children:[e.jsxs(he,{className:"flex items-center gap-2",children:[e.jsx(F,{className:"h-5 w-5 text-orange-500"}),"Confirmar Saída da Agência"]}),e.jsxs(ue,{children:['Esta ação irá processar a saída da agência "',r?.name,'" e redistribuir todos os projetos selecionados. Esta ação não pode ser desfeita.']})]}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Agência:"}),e.jsx("p",{children:r?.name})]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Motivo:"}),e.jsx("p",{children:W.find(s=>s.value===h)?.label})]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Projetos Afetados:"}),e.jsx("p",{children:l.length})]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Valor Total:"}),e.jsx("p",{className:"font-bold text-orange-600",children:M(Z())})]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium text-sm",children:"Redistribuições:"}),e.jsx("div",{className:"mt-2 space-y-2 max-h-40 overflow-y-auto",children:u.map(s=>{const t=z(s.project_id),n=$(s.to_agency_id);return e.jsxs("div",{className:"flex items-center gap-2 text-sm p-2 bg-gray-50 rounded",children:[e.jsx("span",{className:"flex-1",children:t?.title}),e.jsx(G,{className:"h-3 w-3 text-gray-400"}),e.jsx("span",{className:"font-medium",children:n?.name})]},s.project_id)})})]}),E&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-blue-600",children:[e.jsx(ge,{className:"h-4 w-4"}),e.jsx("span",{children:"Clientes serão notificados sobre a mudança"})]})]}),e.jsxs(je,{children:[e.jsx(pe,{disabled:P,children:"Cancelar"}),e.jsx(fe,{onClick:ie,disabled:P,className:"bg-orange-600 hover:bg-orange-700",children:P?"Processando...":"Confirmar Saída"})]})]})})]})]})}const L=[{id:"pa1",name:"Digital Solutions Agency",partner_level:"premium",contact_person:"Ana Silva",email:"ana@digitalsolutions.com",phone:"+55 11 97777-0001",active_projects:8,satisfaction_rating:4.8},{id:"pa2",name:"Creative Partners",partner_level:"elite",contact_person:"Roberto Costa",email:"roberto@creativepartners.com",phone:"+55 11 97777-0002",active_projects:12,satisfaction_rating:4.9},{id:"pa3",name:"Innovation Hub",partner_level:"premium",contact_person:"Mariana Santos",email:"mariana@innovationhub.com",phone:"+55 11 97777-0003",active_projects:6,satisfaction_rating:4.6}],Ce=[{id:"1",title:"Transformação Digital - TechCorp",description:"Projeto completo de transformação digital",client:{id:"c1",name:"João Empresário",email:"joao@techcorp.com",phone:"+55 11 98888-0001",company:"TechCorp Ltda",segment:"Tecnologia",created_from_lead:!0,potential_value:15e4,contact_preference:"email"},status:"ativo",value:15e4,created_at:"2024-01-15T10:00:00Z",updated_at:"2024-01-20T14:30:00Z",commercial_admin:{id:"ca1",name:"Carlos Mendes",email:"carlos.mendes@allka.com",phone:"+55 11 99999-0001",active_projects:5,conversion_rate:75.5},partner_agency:L[0],proposal_date:"2024-01-15",start_date:"2024-01-20",reports:[],history:[],conversion_probability:90,satisfaction_score:4.5,churn_risk:"low"},{id:"2",title:"E-commerce Premium - StartupXYZ",description:"Desenvolvimento de plataforma e-commerce",client:{id:"c2",name:"Maria Gestora",email:"maria@startupxyz.com",phone:"+55 11 98888-0002",company:"StartupXYZ",segment:"E-commerce",created_from_lead:!0,potential_value:85e3,contact_preference:"whatsapp"},status:"ativo",value:85e3,created_at:"2024-01-10T09:00:00Z",updated_at:"2024-01-22T16:45:00Z",commercial_admin:{id:"ca2",name:"Ana Paula Silva",email:"ana.silva@allka.com",phone:"+55 11 99999-0002",active_projects:3,conversion_rate:82.3},partner_agency:L[1],proposal_date:"2024-01-10",start_date:"2024-01-20",reports:[],history:[],conversion_probability:90,satisfaction_score:4.7,churn_risk:"low"}],we=[{id:"churn1",partner_agency_id:"pa-old-1",reason:"Baixa performance nos últimos 6 meses",date:"2024-01-10",affected_projects:["proj1","proj2","proj3"],redistribution_plan:[{project_id:"proj1",from_agency_id:"pa-old-1",to_agency_id:"pa1",redistribution_date:"2024-01-10",reason:"Churn da agência anterior",client_notified:!0}]}];function De(){const[y,D]=c.useState(Ce),[x,H]=c.useState(L),[r,w]=c.useState(we),h=async a=>{console.log("[v0] Processing churn:",a);const d={id:`churn-${Date.now()}`,partner_agency_id:a.partner_agency_id,reason:a.reason,date:new Date().toISOString().split("T")[0],affected_projects:a.affected_projects,redistribution_plan:a.redistribution_plan};w(o=>[d,...o]),H(o=>o.filter(f=>f.id!==a.partner_agency_id))},S=async a=>{console.log("[v0] Redistributing projects:",a),D(d=>d.map(o=>{const f=a.find(m=>m.project_id===o.id);if(f){const m=x.find(P=>P.id===f.to_agency_id);if(m)return{...o,partner_agency:m,updated_at:new Date().toISOString()}}return o}))},k=a=>new Date(a).toLocaleDateString("pt-BR"),A=a=>new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(a),l=()=>y.filter(a=>a.status==="ativo").length,p=()=>y.filter(a=>a.status==="ativo").reduce((a,d)=>a+d.value,0),u=()=>(r.length/(x.length+r.length)*100).toFixed(1);return e.jsxs("div",{className:"space-y-6 my-0 px-1 py-1 mx-3.5",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900",children:"Gestão de Churn - Agências Partner"}),e.jsx("p",{className:"text-gray-600 mt-1",children:"Gerencie a saída de agências Partner e redistribuição de projetos premium"})]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6",children:[e.jsxs(g,{children:[e.jsxs(b,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(_,{className:"text-sm font-medium",children:"Agências Ativas"}),e.jsx(ee,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(j,{children:[e.jsx("div",{className:"text-2xl font-bold",children:x.length}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[x.filter(a=>a.partner_level==="elite").length," Elite,"," ",x.filter(a=>a.partner_level==="premium").length," Premium"]})]})]}),e.jsxs(g,{children:[e.jsxs(b,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(_,{className:"text-sm font-medium",children:"Projetos Ativos"}),e.jsx(U,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(j,{children:[e.jsx("div",{className:"text-2xl font-bold",children:l()}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[A(p())," em valor"]})]})]}),e.jsxs(g,{children:[e.jsxs(b,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(_,{className:"text-sm font-medium",children:"Taxa de Churn"}),e.jsx(_e,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(j,{children:[e.jsxs("div",{className:"text-2xl font-bold",children:[u(),"%"]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Últimos 12 meses"})]})]}),e.jsxs(g,{children:[e.jsxs(b,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(_,{className:"text-sm font-medium",children:"Eventos de Churn"}),e.jsx(I,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(j,{children:[e.jsx("div",{className:"text-2xl font-bold",children:r.length}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Total histórico"})]})]})]}),e.jsx(ye,{projects:y,agencies:x,onProcessChurn:h,onRedistributeProjects:S}),e.jsxs(g,{children:[e.jsxs(b,{children:[e.jsxs(_,{className:"flex items-center gap-2",children:[e.jsx(I,{className:"h-5 w-5"}),"Histórico de Churn"]}),e.jsx(V,{children:"Registro de todas as saídas de agências Partner e redistribuições"})]}),e.jsx(j,{children:r.length>0?e.jsx("div",{className:"space-y-4",children:r.map(a=>e.jsx(g,{className:"border-l-4 border-l-red-500",children:e.jsxs(j,{className:"p-4",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(F,{className:"h-4 w-4 text-red-500"}),e.jsx("span",{className:"font-medium",children:"Saída de Agência"}),e.jsxs(T,{variant:"destructive",className:"text-xs",children:[a.affected_projects.length," projetos afetados"]})]}),e.jsx("p",{className:"text-sm text-gray-900 mb-2",children:a.reason}),e.jsxs("div",{className:"flex items-center gap-4 text-sm text-gray-600",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(ve,{className:"h-3 w-3"}),e.jsx("span",{children:k(a.date)})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(U,{className:"h-3 w-3"}),e.jsxs("span",{children:[a.redistribution_plan.length," redistribuições"]})]})]})]}),e.jsx("div",{className:"text-right",children:e.jsx(T,{variant:"outline",className:"text-xs",children:"Processado"})})]}),a.redistribution_plan.length>0&&e.jsxs("div",{className:"mt-4 pt-4 border-t",children:[e.jsx(C,{className:"text-sm font-medium text-gray-700 mb-2 block",children:"Redistribuições Realizadas"}),e.jsxs("div",{className:"space-y-2",children:[a.redistribution_plan.slice(0,3).map((d,o)=>{const f=x.find(m=>m.id===d.to_agency_id);return e.jsxs("div",{className:"flex items-center gap-2 text-sm p-2 bg-gray-50 rounded",children:[e.jsxs("span",{className:"flex-1",children:["Projeto ",d.project_id]}),e.jsx(G,{className:"h-3 w-3 text-gray-400"}),e.jsx("span",{className:"font-medium",children:f?.name||"Agência não encontrada"}),d.client_notified&&e.jsx(Ne,{className:"h-3 w-3 text-green-500"})]},o)}),a.redistribution_plan.length>3&&e.jsxs("p",{className:"text-xs text-gray-500 text-center",children:["+",a.redistribution_plan.length-3," redistribuições adicionais"]})]})]})]})},a.id))}):e.jsxs("div",{className:"text-center py-12",children:[e.jsx(I,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:"Nenhum evento de churn"}),e.jsx("p",{className:"text-gray-600",children:"Não há registros de saídas de agências Partner no sistema"})]})})]})]})}export{De as default};
